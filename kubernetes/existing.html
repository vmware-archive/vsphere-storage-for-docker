<!DOCTYPE html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="keywords" content=" ">
<title>Configurations on Existing Kubernetes Cluster | Kubernetes vSphere Cloud Provider</title>
<link rel="stylesheet" href="css/syntax.css">


<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
<!--<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">-->
<link rel="stylesheet" href="css/modern-business.css">
<link rel="stylesheet" href="css/infracloudio-lavish-bootstrap.css">
<link rel="stylesheet" href="css/vmware-customstyles.css">
<link rel="stylesheet" href="css/infracloudio-theme-blue.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="js/jquery.navgoco.min.js"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/2.0.0/anchor.min.js"></script>
<script src="js/toc.js"></script>
<script src="js/customscripts.js"></script>

<link rel="shortcut icon" href="images/favicon.ico">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link rel="alternate" type="application/rss+xml" title="" href="http://idratherbewriting.comfeed.xml">

    <script>
        $(document).ready(function() {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

        });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    

</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="fa fa-home fa-lg navbar-brand" href="index.html">&nbsp;<span class="projectTitle"> Kubernetes vSphere Cloud Provider</span></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- entries without drop-downs appear here -->
                
                
                
                <li><a href="index.html">Home</a></li>
                
                
                
                <li><a href="faqs.html">FAQs</a></li>
                
                
                
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                
                
                <!--comment out this block if you want to hide search-->
                <li>
                    <!--start search-->
                    <div id="search-demo-container">
                        <input type="text" id="search-input" placeholder="search...">
                        <ul id="results-container"></ul>
                    </div>
                    <script src="js/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: 'search.json',
                                searchResultTemplate: '<li><a href="{url}" title="Configurations on Existing Kubernetes Cluster">{title}</a></li>',
                    noResultsText: 'No results found.',
                            limit: 10,
                            fuzzy: true,
                    })
                    </script>
                    <!--end search-->
                </li>
            </ul>
        </div>
        </div>
        <!-- /.container -->
</nav>

<!-- Page Content -->
<div class="container">
    <div class="col-lg-12">&nbsp;</div>
    <!-- Content Row -->
    <div class="row">
        <!-- Sidebar Column -->
        <div class="col-md-3">

          












<ul id="mysidebar" class="nav">
    <li class="sidebarTitle">Menu </li>
    
    
    
    <li>
        <a href="#">Get Started</a>
        <ul>
            
            
            
            <li><a href="index.html">Introduction</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">vSphere Cloud Provider</a>
        <ul>
            
            
            
            <li><a href="overview.html">Overview</a></li>
            
            
            
            <li class="subfolders">
                <a href="#">Kubernetes Storage Support</a>
                <ul>
                    
                    
                    
                    <li><a href="kubernetes-volumes.html">Volumes</a></li>
                    
                    
                    
                    
                    
                    <li><a href="persistent-vols-claims.html">Persistent Volumes & Persistent Volumes Claims</a></li>
                    
                    
                    
                    
                    
                    <li><a href="storageclass.html">Dynamic Provisioning & Storage Class</a></li>
                    
                    
                    
                    
                    
                    <li><a href="statefulsets.html">StatefulSets</a></li>
                    
                    
                    
                </ul>
            </li>
            
            
            
            
            
            
            <li><a href="policy-based-mgmt.html">Storage Policy Based Management for Dynamic Provisioning</a></li>
            
            
            
            
            
            
            <li><a href="high-availability.html">High Availability of Kubernetes Cluster</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Deployment</a>
        <ul>
            
            
            
            <li><a href="prerequisites.html">Prerequistes</a></li>
            
            
            
            
            
            
            <li><a href="kubernetes-anywhere.html">Kubernetes Anywhere</a></li>
            
            
            
            
            
            
            <li class="active"><a href="existing.html">Configurations on existing Kubernetes Cluster</a></li>
            
            
            
            
            
            
            <li><a href="bestpractices.html">Best Practices</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Applications & Examples</a>
        <ul>
            
            
            
            <li><a href="guestbook.html">Running Stateful application - Guestbook app</a></li>
            
            
            
            
            
            
            <li><a href="mongodb.html">Running MongoDB on vSphere</a></li>
            
            
            
            
            
            
            <li><a href="minio.html">Deploying S3 Stateful containers - Minio</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Miscellaneous</a>
        <ul>
            
            
            
            <li><a href="faqs.html">FAQs</a></li>
            
            
            
            
            
            
            <li><a href="known-issues.html">Known Issues</a></li>
            
            
            
            
        </ul>
        
        
        
        <!-- if you aren't using the accordion, uncomment this block:
           <p class="external">
               <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
           </p>
           -->
    </li>
</ul>
</div>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>

    <!-- Content Column -->
    <div class="col-md-9">
        <div class="post-header">
   <h1 class="post-title-main">Configurations on Existing Kubernetes Cluster</h1>
</div>



<div class="post-content">

   

    
    
<!-- this handles the automatic toc. use ## for subheads to auto-generate the on-page minitoc. if you use html tags, you must supply an ID for the heading element in order for it to appear in the minitoc. -->
<script>
$( document ).ready(function() {
  // Handler for .ready() called.

$('#toc').toc({ minimumHeaders: 0, listType: 'ul', showSpeed: 0, headers: 'h2,h3,h4' });

/* this offset helps account for the space taken up by the floating toolbar. */
$('#toc').on('click', 'a', function() {
  var target = $(this.getAttribute('href'))
    , scroll_target = target.offset().top

  $(window).scrollTop(scroll_target - 10);
  return false
})
  
});
</script>

<div id="toc"></div>

    


    

    <a target="_blank" href="https://github.com/vmware/docker-volume-vsphere/edit/gh-pages/kubernetes-docs//existing.md" class="btn btn-default githubEditButton" role="button"><i class="fa fa-github fa-lg"></i> Edit me</a>

    

  <p>If a Kubernetes cluster has not been deployed using Kubernetes-Anywhere, follow the instructions below to enable the vSphere Cloud Provider. These steps are not needed when using Kubernetes-Anywhere, they will be done as part of the deployment.</p>

<h2 id="create-a-vm-folder-for-node-vms">Create a VM folder for Node VMs</h2>

<p>Create a VM folder. Follow instructions mentioned in this <a href="https://docs.vmware.com/en/VMware-vSphere/6.0/com.vmware.vsphere.vcenterhost.doc/GUID-031BDB12-D3B2-4E2D-80E6-604F304B4D0C.html">link</a> and move Kubernetes Node VMs to this folder.</p>

<h2 id="make-sure-node-vm-names-are-compliant">Make sure node VM names are compliant</h2>

<p>Make sure Node VM names must comply with the regex <code class="highlighter-rouge">[a-z](([-0-9a-z]+)?[0-9a-z])?(\.[a-z0-9](([-0-9a-z]+)?[0-9a-z])?)*</code> If Node VMs does not comply with this regex, rename them and make it compliant to this regex.</p>

<p>Node VM names constraints:</p>

<ul>
  <li>VM names can not begin with numbers.</li>
  <li>VM names can not have capital letters, any special characters except <code class="highlighter-rouge">.</code> and <code class="highlighter-rouge">-</code>.</li>
  <li>VM names can not be shorter than 3 chars and longer than 63</li>
</ul>

<h2 id="enable-disk-uuid-on-node-virtual-machines">Enable disk UUID on Node virtual machines</h2>

<p>The disk.EnableUUID parameter must be set to “TRUE” for each Node VM. This step is necessary so that the VMDK always presents a consistent UUID to the VM, thus allowing the disk to be mounted properly.</p>

<p>For each of the virtual machine nodes that will be participating in the cluster, follow the steps below using <a href="https://github.com/vmware/govmomi/tree/master/govc">GOVC tool</a></p>

<ul>
  <li>
    <p>Set up GOVC environment</p>

    <div class="highlighter-rouge"><pre class="highlight"><code>  export GOVC_URL='vCenter IP OR FQDN'
  export GOVC_USERNAME='vCenter User'
  export GOVC_PASSWORD='vCenter Password'
  export GOVC_INSECURE=1
</code></pre>
    </div>
  </li>
  <li>
    <p>Find Node VM Paths</p>

    <div class="highlighter-rouge"><pre class="highlight"><code>  govc ls /datacenter/vm/&lt;vm-folder-name&gt;
</code></pre>
    </div>
  </li>
  <li>
    <p>Set disk.EnableUUID to true for all VMs</p>

    <div class="highlighter-rouge"><pre class="highlight"><code>  govc vm.change -e="disk.enableUUID=1" -vm='VM Path'
</code></pre>
    </div>
  </li>
</ul>

<p>Note: If Kubernetes Node VMs are created from template VM then <code class="highlighter-rouge">disk.EnableUUID=1</code> can be set on the template VM. VMs cloned from this template, will automatically inherit this property.</p>

<h2 id="create-roles-add-privileges-to-roles-and-assign-them-to-the-vsphere-cloud-provider-user-and-vsphere-entities">Create Roles, add Privileges to Roles and assign them to the vSphere Cloud Provider user and vSphere entities</h2>

<p>Note: if you want to use Administrator account then this step can be skipped.</p>

<p>vSphere Cloud Provider requires the following minimal set of privileges to interact with vCenter. Please refer <a href="https://docs.vmware.com/en/VMware-vSphere/6.5/com.vmware.vsphere.security.doc/GUID-18071E9A-EED1-4968-8D51-E0B4F526FDA3.html">vSphere Documentation Center</a> to know about steps for creating a Custom Role, User and Role Assignment.</p>

<table>
<thead>
<tr>
  <th>Roles</th>
  <th>Privileges</th>
  <th>Entities</th>
  <th>Propagate to Children</th>
</tr>
</thead>
<tbody><tr>
  <td>manage-k8s-node-vms</td>
  <td>Resource.AssignVMToPool<br /> System.Anonymous<br /> System.Read<br /> System.View<br /> VirtualMachine.Config.AddExistingDisk<br /> VirtualMachine.Config.AddNewDisk<br /> VirtualMachine.Config.AddRemoveDevice<br /> VirtualMachine.Config.RemoveDisk<br /> VirtualMachine.Inventory.Create<br /> VirtualMachine.Inventory.Delete</td>
  <td>Cluster,<br /> Hosts,<br /> VM Folder</td>
  <td>Yes</td>
</tr>
<tr>
  <td>manage-k8s-volumes</td>
  <td>Datastore.AllocateSpace<br /> Datastore.FileManagement<br /> System.Anonymous<br /> System.Read<br /> System.View</td>
  <td>Datastore</td>
  <td>No</td>
</tr>
<tr>
  <td>k8s-system-read-and-spbm-profile-view</td>
  <td>StorageProfile.View<br /> System.Anonymous<br /> System.Read<br /> System.View</td>
  <td>vCenter</td>
  <td>No</td>
</tr>
<tr>
  <td>ReadOnly</td>
  <td>System.Anonymous<br />System.Read<br />System.View</td>
  <td>Datacenter,<br /> Datastore Cluster,<br /> Datastore Storage Folder</td>
  <td>No</td>
</tr>
</tbody>
</table>

<p><strong>Step-5</strong> Create the vSphere cloud config file (<code class="highlighter-rouge">vsphere.conf</code>). Cloud config template can be found <a href="https://github.com/kubernetes/kubernetes-anywhere/blob/master/phase1/vsphere/vsphere.conf">here</a></p>

<p>This config file needs to be placed in the shared directory which should be accessible from kubelet container, controller-manager pod, and API server pod.</p>

<p><strong><code class="highlighter-rouge">vsphere.conf</code> for Master Node:</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>[Global]
        user = "vCenter username for cloud provider"
        password = "password"
        server = "IP/FQDN for vCenter"
        port = "443" #Optional
        insecure-flag = "1" #set to 1 if the vCenter uses a self-signed cert
        datacenter = "Datacenter name" 
        datastore = "Datastore name" #Datastore to use for provisioning volumes using storage classes/dynamic provisioning
        working-dir = "vCenter VM folder path in which node VMs are located"
        vm-name = "VM name of the Master Node" #Optional
        vm-uuid = "UUID of the Node VM" # Optional        
[Disk]
    scsicontrollertype = pvscsi
</code></pre>
</div>

<p>Note: <strong><code class="highlighter-rouge">vm-name</code> parameter is introduced in 1.6.4 release.</strong> Both <code class="highlighter-rouge">vm-uuid</code> and <code class="highlighter-rouge">vm-name</code> are optional parameters. If <code class="highlighter-rouge">vm-name</code> is specified then <code class="highlighter-rouge">vm-uuid</code> is not used. If both are not specified then kubelet will get vm-uuid from <code class="highlighter-rouge">/sys/class/dmi/id/product_serial</code> and query vCenter to find the Node VM’s name.</p>

<p><strong><code class="highlighter-rouge">vsphere.conf</code> for Worker Nodes:</strong> (Only Applicable to 1.6.4 release and above. For older releases this file should have all the parameters specified in Master node’s <code class="highlighter-rouge">vSphere.conf</code> file)</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[Global]
        vm-name = "VM name of the Worker Node"
</code></pre>
</div>

<p>Below is summary of supported parameters in the <code class="highlighter-rouge">vsphere.conf</code> file</p>

<ul>
  <li><code class="highlighter-rouge">user</code> is the vCenter username for vSphere Cloud Provider.</li>
  <li><code class="highlighter-rouge">password</code> is the password for vCenter user specified with <code class="highlighter-rouge">user</code>.</li>
  <li><code class="highlighter-rouge">server</code> is the vCenter Server IP or FQDN</li>
  <li><code class="highlighter-rouge">port</code> is the vCenter Server Port. Default is 443 if not specified.</li>
  <li><code class="highlighter-rouge">insecure-flag</code> is set to 1 if vCenter used a self-signed certificate.</li>
  <li><code class="highlighter-rouge">datacenter</code> is the name of the datacenter on which Node VMs are deployed.</li>
  <li><code class="highlighter-rouge">datastore</code> is the default datastore to use for provisioning volumes using storage classes/dynamic provisioning.</li>
  <li>
    <p><code class="highlighter-rouge">vm-name</code> is recently added configuration parameter. This is optional parameter. When this parameter is present, <code class="highlighter-rouge">vsphere.conf</code> file on the worker node does not need vCenter credentials.</p>

    <p><strong>Note:</strong> <code class="highlighter-rouge">vm-name</code> is added in the release 1.6.4. Prior releases does not support this parameter.</p>
  </li>
  <li><code class="highlighter-rouge">working-dir</code> can be set to empty ( working-dir = “”), if Node VMs are located in the root VM folder.</li>
  <li>
    <p><code class="highlighter-rouge">vm-uuid</code> is the VM Instance UUID of virtual machine. <code class="highlighter-rouge">vm-uuid</code> can be set to empty (<code class="highlighter-rouge">vm-uuid = ""</code>). If set to empty, this will be retrieved from /sys/class/dmi/id/product_serial file on virtual machine (requires root access).</p>

    <ul>
      <li>
        <p><code class="highlighter-rouge">vm-uuid</code> needs to be set in this format - <code class="highlighter-rouge">423D7ADC-F7A9-F629-8454-CE9615C810F1</code></p>
      </li>
      <li>
        <p><code class="highlighter-rouge">vm-uuid</code> can be retrieved from Node Virtual machines using following command. This will be different on each node VM.</p>

        <div class="highlighter-rouge"><pre class="highlight"><code>cat /sys/class/dmi/id/product_serial | sed -e 's/^VMware-//' -e 's/-/ /' | awk '{ print toupper($1$2$3$4 "-" $5$6 "-" $7$8 "-" $9$10 "-" $11$12$13$14$15$16) }'
</code></pre>
        </div>
      </li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">datastore</code> is the default datastore used for provisioning volumes using storage classes. If datastore is located in storage folder or datastore is member of datastore cluster, make sure to specify full datastore path. Make sure vSphere Cloud Provider user has Read Privilege set on the datastore cluster or storage folder to be able to find datastore.
    <ul>
      <li>
        <p>For datastore located in the datastore cluster, specify datastore as mentioned below</p>

        <div class="highlighter-rouge"><pre class="highlight"><code>datastore = "DatastoreCluster/datastore1"
</code></pre>
        </div>
      </li>
      <li>
        <p>For datastore located in the storage folder, specify datastore as mentioned below</p>

        <div class="highlighter-rouge"><pre class="highlight"><code>datastore = "DatastoreStorageFolder/datastore1"
</code></pre>
        </div>
      </li>
    </ul>
  </li>
</ul>

<h2 id="add-flags-to-controller-manager-api-server-and-kubelet">Add flags to controller-manager, API server and Kubelet</h2>

<p>Add flags to controller-manager, API server and Kubelet to enable vSphere Cloud Provider.
* Add following flags to kubelet running on every node and to the controller-manager and API server pods manifest files.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>--cloud-provider=vsphere
--cloud-config=&lt;Path of the vsphere.conf file&gt;
</code></pre>
</div>

<p>Manifest files for API server and controller-manager are generally located at <code class="highlighter-rouge">/etc/kubernetes</code></p>

<h2 id="restart-kubelet-on-all-nodes">Restart Kubelet on all nodes</h2>

<ul>
  <li>Reload kubelet systemd unit file using <code class="highlighter-rouge">systemctl daemon-reload</code></li>
  <li>Restart kubelet service using <code class="highlighter-rouge">systemctl restart kubelet.service</code></li>
</ul>

<p>Note: After enabling the vSphere Cloud Provider, Node names will be set to the VM names from the vCenter Inventory.</p>

  

    <div class="tags">
        
    </div>

    

</div>

<hr class="shaded"/>

<footer>
            <div class="row">
                <div class="col-lg-12 footer">
               &copy;2017 VMWare. All rights reserved. <br />
 Site last generated: Aug 15, 2017 <br />
<p><img src="images/company_logo.png" alt="Company logo"/></p>
                </div>
            </div>
</footer>


    </div>
    <!-- /.row -->
</div>
<!-- /.container -->
    </div>

</body>

</html>