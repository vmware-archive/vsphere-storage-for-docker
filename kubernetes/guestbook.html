<!DOCTYPE html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="keywords" content=" ">
<title>Running Stateful application - Guestbook App | Kubernetes vSphere Cloud Provider</title>
<link rel="stylesheet" href="css/syntax.css">


<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
<!--<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">-->
<link rel="stylesheet" href="css/modern-business.css">
<link rel="stylesheet" href="css/infracloudio-lavish-bootstrap.css">
<link rel="stylesheet" href="css/vmware-customstyles.css">
<link rel="stylesheet" href="css/infracloudio-theme-blue.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="js/jquery.navgoco.min.js"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/2.0.0/anchor.min.js"></script>
<script src="js/toc.js"></script>
<script src="js/customscripts.js"></script>

<link rel="shortcut icon" href="images/favicon.ico">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link rel="alternate" type="application/rss+xml" title="" href="http://idratherbewriting.comfeed.xml">

    <script>
        $(document).ready(function() {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

        });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    

</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="fa fa-home fa-lg navbar-brand" href="index.html">&nbsp;<span class="projectTitle"> Kubernetes vSphere Cloud Provider</span></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- entries without drop-downs appear here -->
                
                
                
                <li><a href="index.html">Home</a></li>
                
                
                
                <li><a href="faqs.html">FAQs</a></li>
                
                
                
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                
                
                <!--comment out this block if you want to hide search-->
                <li>
                    <!--start search-->
                    <div id="search-demo-container">
                        <input type="text" id="search-input" placeholder="search...">
                        <ul id="results-container"></ul>
                    </div>
                    <script src="js/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: 'search.json',
                                searchResultTemplate: '<li><a href="{url}" title="Running Stateful application - Guestbook App">{title}</a></li>',
                    noResultsText: 'No results found.',
                            limit: 10,
                            fuzzy: true,
                    })
                    </script>
                    <!--end search-->
                </li>
            </ul>
        </div>
        </div>
        <!-- /.container -->
</nav>

<!-- Page Content -->
<div class="container">
    <div class="col-lg-12">&nbsp;</div>
    <!-- Content Row -->
    <div class="row">
        <!-- Sidebar Column -->
        <div class="col-md-3">

          












<ul id="mysidebar" class="nav">
    <li class="sidebarTitle">Menu </li>
    
    
    
    <li>
        <a href="#">Get Started</a>
        <ul>
            
            
            
            <li><a href="index.html">Introduction</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">vSphere Cloud Provider</a>
        <ul>
            
            
            
            <li><a href="overview.html">Overview</a></li>
            
            
            
            <li class="subfolders">
                <a href="#">Kubernetes Storage Support</a>
                <ul>
                    
                    
                    
                    <li><a href="kubernetes-volumes.html">Volumes</a></li>
                    
                    
                    
                    
                    
                    <li><a href="persistent-vols-claims.html">Persistent Volumes & Persistent Volumes Claims</a></li>
                    
                    
                    
                    
                    
                    <li><a href="storageclass.html">Dynamic Provisioning & Storage Class</a></li>
                    
                    
                    
                    
                    
                    <li><a href="statefulsets.html">StatefulSets</a></li>
                    
                    
                    
                </ul>
            </li>
            
            
            
            
            
            
            <li><a href="policy-based-mgmt.html">Storage Policy Based Management for Dynamic Provisioning</a></li>
            
            
            
            
            
            
            <li><a href="high-availability.html">High Availability of Kubernetes Cluster</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Deployment</a>
        <ul>
            
            
            
            <li><a href="prerequisites.html">Prerequistes</a></li>
            
            
            
            
            
            
            <li><a href="kubernetes-anywhere.html">Kubernetes Anywhere</a></li>
            
            
            
            
            
            
            <li><a href="existing.html">Configurations on existing Kubernetes Cluster</a></li>
            
            
            
            
            
            
            <li><a href="bestpractices.html">Best Practices</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Applications & Examples</a>
        <ul>
            
            
            
            <li class="active"><a href="guestbook.html">Running Stateful application - Guestbook app</a></li>
            
            
            
            
            
            
            <li><a href="mongodb.html">Running MongoDB on vSphere</a></li>
            
            
            
            
            
            
            <li><a href="minio.html">Deploying S3 Stateful containers - Minio</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Miscellaneous</a>
        <ul>
            
            
            
            <li><a href="faqs.html">FAQs</a></li>
            
            
            
            
            
            
            <li><a href="known-issues.html">Known Issues</a></li>
            
            
            
            
        </ul>
        
        
        
        <!-- if you aren't using the accordion, uncomment this block:
           <p class="external">
               <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
           </p>
           -->
    </li>
</ul>
</div>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>

    <!-- Content Column -->
    <div class="col-md-9">
        <div class="post-header">
   <h1 class="post-title-main">Running Stateful application - Guestbook App</h1>
</div>



<div class="post-content">

   

    
    
<!-- this handles the automatic toc. use ## for subheads to auto-generate the on-page minitoc. if you use html tags, you must supply an ID for the heading element in order for it to appear in the minitoc. -->
<script>
$( document ).ready(function() {
  // Handler for .ready() called.

$('#toc').toc({ minimumHeaders: 0, listType: 'ul', showSpeed: 0, headers: 'h2,h3,h4' });

/* this offset helps account for the space taken up by the floating toolbar. */
$('#toc').on('click', 'a', function() {
  var target = $(this.getAttribute('href'))
    , scroll_target = target.offset().top

  $(window).scrollTop(scroll_target - 10);
  return false
})
  
});
</script>

<div id="toc"></div>

    


    

    <a target="_blank" href="https://github.com/vmware/docker-volume-vsphere/edit/gh-pages/kubernetes-docs//guestbook.md" class="btn btn-default githubEditButton" role="button"><i class="fa fa-github fa-lg"></i> Edit me</a>

    

  <p>Guestbook is PHP application with Redis as backend. In this section, we will demonstrate how to use  Kubernetes deployed on vSphere  to run Guestbook Application with persistent storage. At the end of this demo, you will have a sample guestbook app running inside Kubernetes where the data is resident inside VMDKs managed by vSphere.</p>

<p>The data in the VMDK is independent of the lifecycle of the pods and persists even if pods are deleted.</p>

<p><strong>Storage Setup</strong></p>

<p>The backing VMDK files are needed when dynamic provisioning is not used. The VMDK files need to exist before creating the service in k8s that uses them.</p>

<p>Login to ESX (if more than one ESX is used make sure to have a common/shared datastore) and create the volumes</p>

<div class="highlighter-rouge"><pre class="highlight"><code># VMFS
cd /vmfs/volumes/datastore1/
# VSAN
cd /vmfs/volumes/vsanDatastore/
						
# VMFS
mkdir kubevols # Not needed but good hygiene
# VSAN
/usr/lib/vmware/osfs/bin/osfs-mkdir kubevols # Needed
						
cd kubevols
						
vmkfstools -c 2G redis-slave.vmdk 
vmkfstools -c 2G redis-master.vmdk 
</code></pre>
</div>

<h2 id="guestbook-with-statically-provisioning">Guestbook with statically provisioning</h2>

<p>In this example we will provision PVs and Guestbook pods will claim these PVs</p>

<p>Download all files in the PVC PV Demo from <a href="https://github.com/vmware/kubernetes/tree/kube-examples/kube-examples/guestbook/guestbook-pvc">here</a></p>

<p>Create the persistent volume</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ kubectl create -f redis-master-pv.yaml create -f redis-slave-pv.yaml
</code></pre>
</div>

<p>Check the persistent volume records</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ kubectl get pv
</code></pre>
</div>

<p>Create the PVC</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ kubectl create -f redis-slave-claim.yaml 
$ kubectl create -f redis-master-claim.yaml
</code></pre>
</div>

<p>Check that the volumes are bound to the claims</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ kubectl get pv
 
NAME                CAPACITY ACCESSMODES RECLAMIPOLICY STATUS CLAIM REASON AGE
redis-master-pv 2Gi RWO           Retain    Bound     default/redis-master-claim     34s 
redis-slave-pv 2Gi    RWO         Retain    Bound     default/redis-slave-claim     34s 	 		
</code></pre>
</div>

<p>Create the guestbook</p>

<div class="highlighter-rouge"><pre class="highlight"><code>kubectl create -f guestbook-all-in-one.yaml
</code></pre>
</div>

<h2 id="guestbook-application-with-dynamic-provisioning">Guestbook Application with Dynamic Provisioning</h2>

<p>Download the yaml files for storage class based guestbook from <a href="https://github.com/vmware/kubernetes/tree/kube-examples/kube-examples/guestbook/guestbook-storageclass">here</a></p>

<p>Create the storage class</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ kubectl create -f redis-sc.yaml
</code></pre>
</div>

<p>Create the claims that use the storage class</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$kubectl create -f redis-master-claim.yaml create -f redis-slave-claim.yaml
</code></pre>
</div>

<p>This should trigger creation of storage volumes on the datastore configured for the vSphere Cloud Provider.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[root@promc-2n-dhcp41:/vmfs/volumes/57f5768f-856aa050-fde c-e0db55248054/kubevols] ls *-pvc-* kubernetes-dynamic-pvc-91c9cd60-9a7c-11e6-a431-00505690d6 4d-flat.vmdk kubernetes-dynamic-pvc-a6abf43a-9a7c-11e6-a 431-00505690d64d-flat.vmdk kubernetes-dynamic-pvc-91c9cd60-9a7c-11e6-a431-00505690d6 4d.vmdk kubernetes-dynamic-pvc-a6abf43a-9a7c-11e6-a 431-00505690d64d.vmdk 
</code></pre>
</div>

<p>All the dynamically provisioned volumes will be created in the kubevols directory inside the datastore.</p>

<p>Create the guestbook app consuming the claims</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ kubectl create -f guestbook-all-in-one.yaml 
</code></pre>
</div>

<p>Verify Guestbook Application
The following steps verify that the Pods, storage and the application are running correctly</p>

<p>Wait till the pods are ready</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ kubectl get pods
NAME                         READY STATUS   RESTARTS AGE
frontend-88237173-77e6n       1/1   Running    0     43m
redis-master-1145698066-2hbbk 1/1   Running    0     43m
redis-slave-5845680045-3ffdg  1/1   Running    0     43m		
</code></pre>
</div>

<p>Get the port on which the front end is accessible</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ kubectl describe service frontend | grep NodePort
Type: NodePort
NodePort: &lt;unset&gt; 31531/TCP 
</code></pre>
</div>

<p>Check the nodes on which the frontend is running</p>

<p>Get the IP address of one of the nodes (This can also be obtained from vCenter)
Also possible from vCenter or the console output kube-up</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ kubectl describe node kubernetes-minion-1|grep -i Address 
Addresses: 10.20.105.59 
</code></pre>
</div>

<p>Combine the IP and Port and head to the URL (Ex:
http://10.20.105.59:31531 ). Try out the app and leave a few messages.
To check the attach status of VMDKs on ESX head to vCenter (Settings page or Recent Tasks window)</p>

<h2 id="lifecycle-of-volume-independent-pod">Lifecycle of volume independent Pod</h2>

<p>To test the persistence, delete the guestbook and recreate it using the same volumes, the old messages on the guest book should show up.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ kubectl delete -f guestbook-all-in-one.yaml 
$ kubectl create -f guestbook-all-in-one.yaml
					
</code></pre>
</div>

<p>After create, the port mapping will change.</p>

<div class="highlighter-rouge"><pre class="highlight"><code># Get the new port
$ kubectl describe service frontend| grep NodePort 
Type:                 NodePort
NodePort:      &lt;unset&gt; 32400/TCP 
</code></pre>
</div>

<p>Check the nodes on which the frontend is running</p>


  

    <div class="tags">
        
    </div>

    

</div>

<hr class="shaded"/>

<footer>
            <div class="row">
                <div class="col-lg-12 footer">
               &copy;2017 VMWare. All rights reserved. <br />
 Site last generated: Aug 11, 2017 <br />
<p><img src="images/company_logo.png" alt="Company logo"/></p>
                </div>
            </div>
</footer>


    </div>
    <!-- /.row -->
</div>
<!-- /.container -->
    </div>

</body>

</html>